<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Belichick's Library | Pat Browne</title>
    <meta name="description" content="Searchable catalogue of Bill Belichick's football book collection at the US Naval Academy">

    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/dark.css" media="(prefers-color-scheme: dark)">

    <style>
        /* Layout only - colors from theme */
        .book-catalogue {
            max-width: 900px;
            margin: 0 auto;
        }

        .search-wrapper {
            margin-bottom: 1rem;
        }

        #book-search {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .filter-sort-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filters select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .results-count {
            font-size: 0.875rem;
        }

        .catalogue-table-wrapper {
            overflow-x: auto;
        }

        .catalogue-table {
            width: 100%;
            border-collapse: collapse;
        }

        .catalogue-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .sort-indicator::after {
            content: '';
            margin-left: 0.25rem;
        }

        .sort-asc .sort-indicator::after {
            content: ' \25B2';
        }

        .sort-desc .sort-indicator::after {
            content: ' \25BC';
        }

        .book-year {
            font-variant-numeric: tabular-nums;
            text-align: right;
        }

        .book-links {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        .book-links a {
            display: inline-flex;
            font-size: 0.75rem;
            padding: 0.2rem 0.4rem;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .no-results {
            padding: 2rem;
            text-align: center;
        }

        .meta-section {
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .meta-section p {
            margin: 0.5rem 0;
        }

        .link-guide {
            margin: 1rem 0;
        }

        .link-guide p {
            margin: 0.25rem 0;
        }

        @media (max-width: 768px) {
            .catalogue-table thead { display: none; }
            .catalogue-table, .catalogue-table tbody, .catalogue-table tr, .catalogue-table td { display: block; }
            .catalogue-table tr { padding: 1rem 0; border-bottom: 1px solid #ddd; }
            .catalogue-table td { padding: 0.25rem 0; border: none; }
            .catalogue-table td:first-child { font-weight: 600; }
            .book-links { margin-top: 0.5rem; }
        }

        @media (prefers-color-scheme: dark) {
            #book-search, .filters select { background: #111; border-color: #444; color: #ddd; }
            .book-links a { border-color: #444; }
            .catalogue-table tr { border-color: #444; }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <header class="header">
            <h1 class="site-title"><a href="/">Pat Browne</a></h1>
            <nav>
                <ul class="flat">
                    <li><a href="/">Home</a></li>
                    <li><a href="/posts/">Posts</a></li>
                    <li><a href="/about/">About</a></li>
                </ul>
            </nav>
        </header>

        <main class="container">
            <article class="book-catalogue">
                <h1 class="page-title">Belichick's Library</h1>

                <section class="meta-section">
                    <p><a href="/belichick-about/">About this collection</a></p>
                    <p><strong><span id="total-count">568</span> books</strong> in the catalogue. Data is still being cleaned and may not be fully accurate. Categories were assigned by USNA.</p>

                    <div class="link-guide">
                        <p><strong>Link abbreviations:</strong></p>
                        <p>WC = <a href="https://www.worldcat.org" target="_blank" rel="noopener">WorldCat</a> (find in libraries)</p>
                        <p>IA = <a href="https://archive.org" target="_blank" rel="noopener">Internet Archive</a> (free digital books)</p>
                        <p>AA = <a href="https://annas-archive.org" target="_blank" rel="noopener">Anna's Archive</a> (search aggregator)</p>
                        <p>BF = <a href="https://www.bookfinder.com" target="_blank" rel="noopener">BookFinder</a> (buy used copies)</p>
                    </div>
                </section>

                <section class="catalogue-controls">
                    <div class="search-wrapper">
                        <input type="search"
                               id="book-search"
                               placeholder="Search by title, author, or keyword..."
                               aria-label="Search books">
                    </div>

                    <div class="filter-sort-row">
                        <div class="filters">
                            <select id="filter-category" aria-label="Filter by category">
                                <option value="">All Categories</option>
                                <option value="Biography">Biography</option>
                                <option value="Football History">Football History</option>
                                <option value="Instructional">Instructional</option>
                                <option value="Navy/Military">Navy/Military</option>
                                <option value="General Sports">General Sports</option>
                            </select>

                            <select id="filter-decade" aria-label="Filter by decade">
                                <option value="">All Decades</option>
                            </select>
                        </div>

                        <div class="results-count">
                            <span id="showing-count">0</span> of <span id="total-count-2">0</span> books
                        </div>
                    </div>
                </section>

                <section class="catalogue-table-wrapper">
                    <table class="catalogue-table" id="books-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="title">Title<span class="sort-indicator"></span></th>
                                <th class="sortable" data-sort="author">Author<span class="sort-indicator"></span></th>
                                <th class="sortable" data-sort="year">Year<span class="sort-indicator"></span></th>
                                <th>Find</th>
                            </tr>
                        </thead>
                        <tbody id="books-tbody">
                            <tr><td colspan="4" class="no-results">Loading...</td></tr>
                        </tbody>
                    </table>
                </section>
            </article>
        </main>

        <footer class="footer">
            <a href="/">Pat Browne</a>
        </footer>
    </div>

    <script src="/js/fuse.min.js"></script>
    <script>
    (function() {
        'use strict';

        let books = [];
        let filteredBooks = [];
        let fuse = null;
        let currentSort = { field: 'title', direction: 'asc' };

        const searchInput = document.getElementById('book-search');
        const categoryFilter = document.getElementById('filter-category');
        const decadeFilter = document.getElementById('filter-decade');
        const tbody = document.getElementById('books-tbody');
        const showingCount = document.getElementById('showing-count');
        const totalCount = document.getElementById('total-count');
        const totalCount2 = document.getElementById('total-count-2');
        const headers = document.querySelectorAll('.catalogue-table th.sortable');

        async function init() {
            try {
                const response = await fetch('/data/books.json');
                if (!response.ok) throw new Error('Failed to fetch');
                const data = await response.json();
                books = data.books;

                totalCount.textContent = books.length;
                totalCount2.textContent = books.length;

                // Initialize Fuse.js for fuzzy search
                fuse = new Fuse(books, {
                    keys: ['title', 'author', 'keywords'],
                    threshold: 0.4,
                    ignoreLocation: true,
                    includeScore: true
                });

                populateDecadeFilter();
                applyFiltersAndSort();
            } catch (err) {
                console.error('Failed to load books:', err);
                tbody.innerHTML = '<tr><td colspan="4" class="no-results">Failed to load book data.</td></tr>';
            }
        }

        function populateDecadeFilter() {
            const decades = new Set();
            books.forEach(book => {
                if (book.year) {
                    const decade = Math.floor(book.year / 10) * 10;
                    decades.add(decade);
                }
            });
            Array.from(decades).sort((a, b) => a - b).forEach(decade => {
                const option = document.createElement('option');
                option.value = decade;
                option.textContent = decade + 's';
                decadeFilter.appendChild(option);
            });
        }

        function applyFiltersAndSort() {
            const searchTerm = searchInput.value.trim();
            const categoryValue = categoryFilter.value;
            const decadeValue = decadeFilter.value;

            let baseBooks = books;

            // Fuzzy search with Fuse.js
            if (searchTerm && fuse) {
                const results = fuse.search(searchTerm);
                baseBooks = results.map(r => r.item);
            }

            // Apply filters
            filteredBooks = baseBooks.filter(book => {
                if (categoryValue && book.category !== categoryValue) return false;
                if (decadeValue) {
                    if (!book.year) return false;
                    if (Math.floor(book.year / 10) * 10 !== parseInt(decadeValue)) return false;
                }
                return true;
            });

            // Sort (skip if search is active - keep relevance order)
            if (!searchTerm) {
                sortBooks();
            }

            renderBooks();
            updateCount();
            updateSortIndicators();
        }

        function sortBooks() {
            filteredBooks.sort((a, b) => {
                let aVal, bVal;
                if (currentSort.field === 'author') {
                    aVal = a.author_sort || a.author || '';
                    bVal = b.author_sort || b.author || '';
                } else if (currentSort.field === 'year') {
                    aVal = a.year || 0;
                    bVal = b.year || 0;
                    return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                } else {
                    aVal = a[currentSort.field] || '';
                    bVal = b[currentSort.field] || '';
                }
                const cmp = String(aVal).localeCompare(String(bVal));
                return currentSort.direction === 'asc' ? cmp : -cmp;
            });
        }

        function renderBooks() {
            if (filteredBooks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-results">No books found.</td></tr>';
                return;
            }

            const isMobile = window.innerWidth <= 768;
            tbody.innerHTML = filteredBooks.map(book => {
                const title = escapeHtml(book.title);
                const author = escapeHtml(book.author || '\u2014');
                const year = book.year_display || '\u2014';
                const links = '<div class="book-links">' +
                    '<a href="' + book.links.worldcat + '" target="_blank" rel="noopener" title="WorldCat">WC</a>' +
                    '<a href="' + book.links.internet_archive + '" target="_blank" rel="noopener" title="Internet Archive">IA</a>' +
                    '<a href="' + book.links.annas_archive + '" target="_blank" rel="noopener" title="Anna\'s Archive">AA</a>' +
                    '<a href="' + book.links.bookfinder + '" target="_blank" rel="noopener" title="BookFinder">BF</a>' +
                '</div>';

                if (isMobile) {
                    return '<tr><td>' + title + '</td><td>' + author + '</td><td>' + year + '</td><td>' + links + '</td></tr>';
                }
                return '<tr><td>' + title + '</td><td>' + author + '</td><td class="book-year">' + year + '</td><td>' + links + '</td></tr>';
            }).join('');
        }

        function updateCount() {
            showingCount.textContent = filteredBooks.length;
        }

        function updateSortIndicators() {
            headers.forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === currentSort.field) {
                    th.classList.add('sort-' + currentSort.direction);
                }
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(fn, delay) {
            let timeout;
            return function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, arguments), delay);
            };
        }

        searchInput.addEventListener('input', debounce(applyFiltersAndSort, 150));
        categoryFilter.addEventListener('change', applyFiltersAndSort);
        decadeFilter.addEventListener('change', applyFiltersAndSort);

        window.addEventListener('resize', debounce(function() {
            renderBooks();
        }, 100));

        headers.forEach(th => {
            th.addEventListener('click', function() {
                const field = th.dataset.sort;
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'asc';
                }
                sortBooks();
                renderBooks();
                updateSortIndicators();
            });
        });

        init();
    })();
    </script>
</body>
</html>
